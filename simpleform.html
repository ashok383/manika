// app.js - Single file Razorpay integration demo

const express = require('express');
const Razorpay = require('razorpay');
const bodyParser = require('body-parser');
const path = require('path');

const app = express();
app.use(bodyParser.json());
app.use(express.static(__dirname)); // serve static HTML

// ============ CONFIGURATION ============
const razorpay = new Razorpay({
    key_id: "rzp_live_S5ex0BvHGJcmo6",       // replace with your Razorpay key_id
    key_secret: "ZvWJBmFchb1zNW8Enetwmpop" // replace with your Razorpay key_secret
});

// ============ SERVE HTML PAGE ============
app.get("/", (req, res) => {
    res.send(`
<!DOCTYPE html>
<html>
<head>
    <title>Razorpay Payment Demo</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <h2>Razorpay Payment Demo</h2>
    <button id="payBtn">Pay ₹100</button>

    <script>
        document.getElementById("payBtn").onclick = async function() {
            // call backend to create order
            const res = await fetch("/create-order", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ amount: 10000 }) // ₹100 in paise
            });
            const order = await res.json();

            var options = {
                "key": "${razorpay.key_id}", // your key_id
                "amount": order.amount,
                "currency": order.currency,
                "name": "Test Payment",
                "description": "Razorpay Demo",
                "order_id": order.id,
                "handler": function (response){
                    alert("Payment Success! Payment ID: " + response.razorpay_payment_id);
                },
                "prefill": {
                    "name": "John Doe",
                    "email": "john@example.com",
                    "contact": "9999999999"
                },
                "theme": {
                    "color": "#3399cc"
                }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
        }
    </script>
</body>
</html>
    `);
});

// ============ CREATE ORDER ============
app.post("/create-order", async (req, res) => {
    const { amount } = req.body;
    try {
        const order = await razorpay.orders.create({
            amount: amount,
            currency: "INR",
            receipt: "receipt#1"
        });
        res.json(order);
    } catch(err) {
        res.status(500).send(err);
    }
});

// ============ START SERVER ============
const PORT = 3000;
app.listen(PORT, () => {
    console.log(`Server running on http://localhost:${PORT}`);
});
