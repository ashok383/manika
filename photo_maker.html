<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>(MANIK-A-RNIKA) Photo Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
body{
  min-height:100vh;
  display:flex;
  justify-content:center;
  padding:15px;
  background:linear-gradient(120deg,#ff9a9e,#fad0c4,#a18cd1,#fbc2eb);
  background-size:400% 400%;
  animation:gradBG 15s ease infinite;
}
@keyframes gradBG{
  0%{background-position:0% 50%}
  50%{background-position:100% 50%}
  100%{background-position:0% 50%}
}
.app{
  width:100%;
  max-width:560px;
  background:rgba(255,255,255,0.25);
  backdrop-filter:blur(18px);
  border-radius:26px;
  padding:22px;
  color:#fff;
  box-shadow:0 12px 35px rgba(0,0,0,0.3);
}
header{text-align:center;margin-bottom:18px}
header h2{font-size:1.9em;font-weight:700}

/* Buttons */
.upload-btn, .btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:28px;
  font-size:16px;
  font-weight:bold;
  color:#fff;
  cursor:pointer;
  margin-top:8px;
  text-align:center;
}
.upload-btn{background:linear-gradient(135deg,#00c6ff,#0072ff);}
.upload-btn input{display:none;}
.btn-photo{background:linear-gradient(135deg,#f7971e,#ffd200);}
.btn-sheet{background:linear-gradient(135deg,#00f260,#0575e6);}

/* Color picker */
.color-box{
  margin-top:12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(255,255,255,0.25);
  padding:10px 14px;
  border-radius:16px;
}

/* Canvas styling */
canvas{
  display:block;
  margin:15px auto;
  max-width:100%;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.35);
}
</style>
</head>

<body>
<div class="app">
<header><h2>(MANIK-A-RNIKA) Photo Tool</h2></header>

<label class="upload-btn">
  ðŸ“¸ Upload Photo
  <input type="file" id="upload" accept="image/*">
</label>

<div class="color-box">
  <span>ðŸŽ¨ Photo Background</span>
  <input type="color" id="bgColor" value="#87CEEB">
</div>

<canvas id="photoCanvas"></canvas>
<button class="btn btn-photo" onclick="downloadPhoto()">â¬‡ Download Photo</button>

<canvas id="sheetCanvas"></canvas>
<button class="btn btn-sheet" onclick="downloadSheet()">â¬‡ Download Photo Sheet</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<script>
const upload=document.getElementById("upload");
const bgColor=document.getElementById("bgColor");
const photoCanvas=document.getElementById("photoCanvas");
const sheetCanvas=document.getElementById("sheetCanvas");

let imageBitmap=null;
let finalSheet=null;

// 35x45mm @300DPI
const PW=Math.round(35/25.4*300);
const PH=Math.round(45/25.4*300);

/* Upload */
upload.onchange=async e=>{
  imageBitmap=await createImageBitmap(e.target.files[0]);
  segmenter.send({image:imageBitmap});
};

/* AI Segmentation */
const segmenter=new SelfieSegmentation({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
});
segmenter.setOptions({modelSelection:1});

segmenter.onResults(res=>{
  if(!imageBitmap) return;

  // High-res temp canvas
  const temp=document.createElement("canvas");
  temp.width=PW*2;
  temp.height=PH*2;
  const ctx=temp.getContext("2d");
  ctx.imageSmoothingEnabled=true;

  ctx.drawImage(imageBitmap,0,0,temp.width,temp.height);
  ctx.globalCompositeOperation="destination-in";
  ctx.drawImage(res.segmentationMask,0,0,temp.width,temp.height);

  ctx.globalCompositeOperation="destination-over";
  ctx.fillStyle=bgColor.value;
  ctx.fillRect(0,0,temp.width,temp.height);
  ctx.globalCompositeOperation="source-over";

  // Downscale for final photo
  const final=document.createElement("canvas");
  final.width=PW;
  final.height=PH;
  final.getContext("2d").drawImage(temp,0,0,PW,PH);

  sharpen(final);
  drawRounded(final,photoCanvas,28,8);

  // High-quality sheet generation
  finalSheet=createHighQualitySheet(photoCanvas);
  previewSheet(finalSheet);
});

/* Sharpen */
function sharpen(canvas){
  const c=canvas.getContext("2d");
  const img=c.getImageData(0,0,canvas.width,canvas.height);
  const d=img.data;
  for(let i=0;i<d.length;i+=4){
    d[i]=Math.min(255,d[i]*1.1);
    d[i+1]=Math.min(255,d[i+1]*1.1);
    d[i+2]=Math.min(255,d[i+2]*1.1);
  }
  c.putImageData(img,0,0);
}

/* Rounded */
function drawRounded(src,dst,r,b){
  dst.width=src.width;
  dst.height=src.height;
  const c=dst.getContext("2d");
  c.clearRect(0,0,dst.width,dst.height);
  c.save();
  c.beginPath();
  c.moveTo(r,0);
  c.arcTo(dst.width,0,dst.width,dst.height,r);
  c.arcTo(dst.width,dst.height,0,dst.height,r);
  c.arcTo(0,dst.height,0,0,r);
  c.arcTo(0,0,dst.width,0,r);
  c.closePath();
  c.clip();
  c.drawImage(src,0,0);
  c.restore();
  c.lineWidth=b;
  c.strokeStyle="#000";
  c.stroke();
}

/* High-quality landscape sheet (2x4) */
function createHighQualitySheet(photo){
  const rows=2,cols=4,gap=25,margin=35;

  // Use double size for AI-quality
  const tempCanvas=document.createElement("canvas");
  tempCanvas.width=cols*photo.width*2 + (cols-1)*gap*2 + margin*4;
  tempCanvas.height=rows*photo.height*2 + (rows-1)*gap*2 + margin*4;
  const ctx=tempCanvas.getContext("2d");
  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,tempCanvas.width,tempCanvas.height);

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      ctx.drawImage(photo, 
        margin*2 + c*(photo.width*2 + gap*2),
        margin*2 + r*(photo.height*2 + gap*2),
        photo.width*2,
        photo.height*2
      );
    }
  }

  // Apply sharpening for AI-quality
  sharpen(tempCanvas);

  // Downscale to normal size for canvas display
  const finalSheetCanvas=document.createElement("canvas");
  finalSheetCanvas.width=tempCanvas.width/2;
  finalSheetCanvas.height=tempCanvas.height/2;
  const finalCtx=finalSheetCanvas.getContext("2d");
  finalCtx.imageSmoothingEnabled=true;
  finalCtx.drawImage(tempCanvas,0,0,finalSheetCanvas.width,finalSheetCanvas.height);

  return finalSheetCanvas;
}

/* Preview */
function previewSheet(sheet){
  const ctx=sheetCanvas.getContext("2d");
  const scale=Math.min(500/sheet.width,360/sheet.height);
  sheetCanvas.width=sheet.width;
  sheetCanvas.height=sheet.height;
  sheetCanvas.style.width=sheet.width*scale+"px";
  sheetCanvas.style.height=sheet.height*scale+"px";
  ctx.drawImage(sheet,0,0);
}

/* Manual download */
function downloadPhoto(){
  if(!photoCanvas.width) return alert("Upload photo first");
  const a=document.createElement("a");
  a.href=photoCanvas.toDataURL("image/png");
  a.download="photo.png";
  a.click();
}

function downloadSheet(){
  if(!finalSheet) return alert("Sheet not ready");
  const a=document.createElement("a");
  a.href=finalSheet.toDataURL("image/png");
  a.download="photo_sheet_2x4.png";
  a.click();
}
</script>
</body>
</html>
