<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>(MANIK-A-RNIKA) Photo Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}

body{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding:15px;
  background:linear-gradient(120deg,#ff9a9e,#fad0c4,#a18cd1,#fbc2eb);
  background-size:400% 400%;
  animation:gradBG 15s ease infinite;
}
@keyframes gradBG{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}

.app{
  width:100%;
  max-width:520px;
  background:rgba(255,255,255,0.25);
  backdrop-filter:blur(18px);
  border-radius:26px;
  padding:22px;
  color:#fff;
  box-shadow:0 12px 35px rgba(0,0,0,0.3);
}

header{text-align:center;margin-bottom:18px;}
header h2{font-size:1.9em;font-weight:700;}

.controls{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-bottom:18px;
}

/* Upload Button */
.upload-btn{
  background:linear-gradient(135deg,#00c6ff,#0072ff);
  padding:14px;
  border-radius:18px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
  transition:.25s;
}
.upload-btn:hover{transform:scale(1.05);}
.upload-btn input{display:none}

/* Color Picker */
.color-box{
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:rgba(255,255,255,0.25);
  padding:10px 14px;
  border-radius:16px;
}

canvas{
  display:block;
  margin:12px auto;
  max-width:100%;
  border-radius:22px;
  box-shadow:0 10px 25px rgba(0,0,0,.35);
}

.sheet-preview{text-align:center;margin-top:20px}

/* Buttons */
.btn{
  width:100%;
  padding:14px;
  margin-top:8px;
  border:none;
  border-radius:30px;
  font-size:16px;
  font-weight:bold;
  color:#fff;
  cursor:pointer;
  transition:.25s;
}

.btn-photo{
  background:linear-gradient(135deg,#f7971e,#ffd200);
}

.btn-sheet{
  background:linear-gradient(135deg,#00f260,#0575e6);
}

.btn:hover{transform:scale(1.05)}
</style>
</head>

<body>
<div class="app">

<header>
  <h2>(MANIK-A-RNIKA) Photo Tool</h2>
</header>

<div class="controls">

  <!-- Upload -->
  <label class="upload-btn">
    ðŸ“¸ Upload Photo
    <input type="file" id="upload" accept="image/*">
  </label>

  <!-- Background Color -->
  <div class="color-box">
    <span>ðŸŽ¨ Background Color</span>
    <input type="color" id="bgColor" value="#ffffff">
  </div>

</div>

<canvas id="photoCanvas"></canvas>
<button class="btn btn-photo" onclick="downloadPhoto()">â¬‡ Download Photo</button>

<div class="sheet-preview">
  <canvas id="sheetCanvas"></canvas>
  <button class="btn btn-sheet" onclick="downloadSheet()">â¬‡ Download Photo Sheet</button>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<script>
const upload = document.getElementById("upload");
const bgColorInput = document.getElementById("bgColor");
const photoCanvas = document.getElementById("photoCanvas");
const sheetCanvas = document.getElementById("sheetCanvas");

let imageBitmap = null;
let sheetCanvasData = null;

// 35x45 mm @ 300 DPI
const PHOTO_WIDTH = Math.round(35 / 25.4 * 300);
const PHOTO_HEIGHT = Math.round(45 / 25.4 * 300);

/* ===== Upload ===== */
upload.onchange = async e => {
  imageBitmap = await createImageBitmap(e.target.files[0]);
  processImage();
};

/* ===== AI Segmentation ===== */
const segmenter = new SelfieSegmentation({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
});
segmenter.setOptions({modelSelection:1});

segmenter.onResults(results => {
  if(!imageBitmap) return;

  const tmp = document.createElement("canvas");
  tmp.width = PHOTO_WIDTH;
  tmp.height = PHOTO_HEIGHT;
  const ctx = tmp.getContext("2d");

  ctx.fillStyle = bgColorInput.value;
  ctx.fillRect(0,0,tmp.width,tmp.height);

  ctx.save();
  ctx.drawImage(imageBitmap,0,0,tmp.width,tmp.height);
  ctx.globalCompositeOperation="destination-in";
  ctx.drawImage(results.segmentationMask,0,0,tmp.width,tmp.height);
  ctx.restore();

  drawRoundedPhoto(tmp, photoCanvas, 30, 10);

  sheetCanvasData = createSheet(photoCanvas);
  showSheetPreview();
});

bgColorInput.oninput = ()=> imageBitmap && processImage();

function processImage(){
  segmenter.send({image:imageBitmap});
}

/* ===== Rounded Photo ===== */
function drawRoundedPhoto(src, dst, r, bw){
  dst.width = src.width;
  dst.height = src.height;
  const c = dst.getContext("2d");

  c.clearRect(0,0,dst.width,dst.height);
  c.save();
  c.beginPath();
  c.moveTo(r,0);
  c.arcTo(dst.width,0,dst.width,dst.height,r);
  c.arcTo(dst.width,dst.height,0,dst.height,r);
  c.arcTo(0,dst.height,0,0,r);
  c.arcTo(0,0,dst.width,0,r);
  c.closePath();
  c.clip();
  c.drawImage(src,0,0);
  c.restore();

  c.lineWidth=bw;
  c.strokeStyle="#000";
  c.stroke();
}

/* ===== AUTO ORIENTATION SHEET ===== */
function createSheet(photo){
  const isPortrait = photo.height > photo.width;
  const rows = isPortrait ? 4 : 2;
  const cols = isPortrait ? 2 : 4;

  const gap = 20, margin = 30;
  const pw = photo.width, ph = photo.height;

  const canvas = document.createElement("canvas");
  canvas.width = cols*pw + (cols-1)*gap + margin*2;
  canvas.height = rows*ph + (rows-1)*gap + margin*2;

  const c = canvas.getContext("2d");
  c.fillStyle = bgColorInput.value;
  c.fillRect(0,0,canvas.width,canvas.height);

  for(let r=0;r<rows;r++){
    for(let cl=0;cl<cols;cl++){
      c.drawImage(photo,
        margin + cl*(pw+gap),
        margin + r*(ph+gap)
      );
    }
  }
  return canvas;
}

/* ===== Preview ===== */
function showSheetPreview(){
  const ctx = sheetCanvas.getContext("2d");
  const scale = Math.min(420/sheetCanvasData.width,300/sheetCanvasData.height);
  sheetCanvas.width = sheetCanvasData.width;
  sheetCanvas.height = sheetCanvasData.height;
  sheetCanvas.style.width = sheetCanvas.width*scale+"px";
  sheetCanvas.style.height = sheetCanvas.height*scale+"px";
  ctx.drawImage(sheetCanvasData,0,0);
}

/* ===== Downloads ===== */
function downloadPhoto(){
  const a=document.createElement("a");
  a.download="photo.png";
  a.href=photoCanvas.toDataURL();
  a.click();
}
function downloadSheet(){
  const a=document.createElement("a");
  a.download="photosheet.png";
  a.href=sheetCanvasData.toDataURL();
  a.click();
}
</script>
</body>
</html>
