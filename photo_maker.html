<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>(MANIK-A-RNIKA) Photo Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{
  min-height:100vh;
  font-family:'Segoe UI',sans-serif;
  display:flex;
  justify-content:center;
  padding:20px;
  background: linear-gradient(120deg,#ff9a9e,#fad0c4,#a18cd1,#fbc2eb);
}
.app{
  background:rgba(255,255,255,0.25);
  backdrop-filter:blur(18px);
  border-radius:28px;
  padding:30px;
  width:min(1200px,95%);
  color:#fff;
}
header{text-align:center;margin-bottom:20px;}
.controls{
  display:flex;
  gap:20px;
  flex-wrap:wrap;
  justify-content:center;
}
button{
  padding:16px 35px;
  border:none;
  border-radius:30px;
  font-weight:bold;
  cursor:pointer;
  color:#fff;
}
.process{background:#ff3333;}
.preview{background:#22c55e;}
canvas{
  display:block;
  margin:20px auto;
  box-shadow:0 15px 40px rgba(0,0,0,.35);
}
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  justify-content:center;
}
.modal-content{
  background:rgba(255,255,255,.15);
  padding:20px;
  border-radius:20px;
}
</style>
</head>

<body>

<div class="app">
<header><h2>(MANIK-A-RNIKA) Photo Tool</h2></header>

<div class="controls">
  <input type="file" id="upload" accept="image/*">
  <input type="color" id="bgColor" value="#ffffff">
  <button class="process" onclick="processImage()">Process Photo</button>
</div>

<canvas id="photoCanvas"></canvas>
<button class="preview" onclick="openModal()">Preview & Download</button>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <canvas id="sheetCanvas"></canvas><br><br>
    <button class="preview" onclick="downloadSheet()">Download Sheet</button>
  </div>
</div>

<!-- AI MODEL -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>

<script>
const upload = document.getElementById("upload");
const photoCanvas = document.getElementById("photoCanvas");
const sheetCanvas = document.getElementById("sheetCanvas");
const bgColor = document.getElementById("bgColor");
const modal = document.getElementById("modal");

const ctx = photoCanvas.getContext("2d");
const sheetCtx = sheetCanvas.getContext("2d");

let imageBitmap;

/* ========= LOAD IMAGE ========= */
upload.onchange = async e => {
  imageBitmap = await createImageBitmap(e.target.files[0]);
};

/* ========= AI SEGMENTATION ========= */
const segmenter = new SelfieSegmentation({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
});
segmenter.setOptions({ modelSelection: 1 });

segmenter.onResults(results => {
  const w = photoCanvas.width;
  const h = photoCanvas.height;

  ctx.clearRect(0,0,w,h);

  // Background color
  ctx.fillStyle = bgColor.value;
  ctx.fillRect(0,0,w,h);

  // Mask
  ctx.globalCompositeOperation = "destination-over";
  ctx.drawImage(results.segmentationMask,0,0,w,h);

  ctx.globalCompositeOperation = "destination-in";
  ctx.drawImage(results.segmentationMask,0,0,w,h);

  ctx.globalCompositeOperation = "destination-over";
  ctx.drawImage(imageBitmap,0,0,w,h);

  ctx.globalCompositeOperation = "source-over";

  roundPhoto(15);
  drawBorder();
  createSheet();
});

/* ========= PROCESS ========= */
function processImage(){
  const w = Math.round(35 * 11.81);
  const h = Math.round(45 * 11.81);

  photoCanvas.width = w;
  photoCanvas.height = h;

  segmenter.send({ image: imageBitmap });
}

/* ========= ROUND + BORDER ========= */
function roundPhoto(r){
  const temp=document.createElement("canvas");
  temp.width=photoCanvas.width;
  temp.height=photoCanvas.height;
  temp.getContext("2d").drawImage(photoCanvas,0,0);

  ctx.clearRect(0,0,photoCanvas.width,photoCanvas.height);
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(r,0);
  ctx.lineTo(photoCanvas.width-r,0);
  ctx.quadraticCurveTo(photoCanvas.width,0,photoCanvas.width,r);
  ctx.lineTo(photoCanvas.width,photoCanvas.height-r);
  ctx.quadraticCurveTo(photoCanvas.width,photoCanvas.height,photoCanvas.width-r,photoCanvas.height);
  ctx.lineTo(r,photoCanvas.height);
  ctx.quadraticCurveTo(0,photoCanvas.height,0,photoCanvas.height-r);
  ctx.lineTo(0,r);
  ctx.quadraticCurveTo(0,0,r,0);
  ctx.closePath();
  ctx.clip();
  ctx.drawImage(temp,0,0);
  ctx.restore();
}

function drawBorder(){
  ctx.lineWidth=14;
  ctx.strokeStyle="#000";
  ctx.strokeRect(7,7,photoCanvas.width-14,photoCanvas.height-14);
}

/* ========= SHEET ========= */
function createSheet(){
  sheetCanvas.width=1800;
  sheetCanvas.height=1200;
  sheetCtx.fillStyle="#fff";
  sheetCtx.fillRect(0,0,1800,1200);

  let x=40,y=40;
  for(let r=0;r<2;r++){
    for(let c=0;c<4;c++){
      sheetCtx.drawImage(photoCanvas,x,y);
      x+=photoCanvas.width+20;
    }
    x=40;
    y+=photoCanvas.height+20;
  }
}

function openModal(){modal.style.display="flex";}
function downloadSheet(){
  const a=document.createElement("a");
  a.download="photosheet_6x4.png";
  a.href=sheetCanvas.toDataURL();
  a.click();
}
</script>

</body>
</html>
