<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
let paid = false;
let printed = false;

/* Academic controls */
function addAcademic(){
  const c=document.getElementById("academicsContainer");
  const d=document.createElement("div");
  d.className="academicRow";
  d.style.display="flex";
  d.style.gap="5px";
  d.innerHTML=`
    <input value="Course">
    <input value="Institute">
    <input value="Year">
    <input value="GPA">
    <button class="remove-btn" onclick="this.parentElement.remove()">✖</button>
  `;
  c.appendChild(d);
}

/* Main Print Button */
function previewCV(){
  if(printed){
    alert("❌ Print already used.");
    return;
  }
  if(!paid){
    startPayment();
    return;
  }
  openAndPrint();
}

/* Razorpay TEST Payment */
function startPayment(){
  var options = {
    key: "rzp_test_1DP5mmOlF5G5ag",   // TEST KEY
    amount: 5000,                   // ₹50
    currency: "INR",
    name: "Resume Builder",
    description: "Single Resume Print",
    handler: function () {
      paid = true;
      openAndPrint();
    }
  };
  new Razorpay(options).open();
}

/* Open resume & PRINT ONLY ONCE */
function openAndPrint(){
  if(printed) return;
  printed = true;

  const photo=document.getElementById("photo").files[0];
  const reader=new FileReader();
  reader.onload=e=>printWindow(e.target.result);
  photo ? reader.readAsDataURL(photo) : printWindow("");
}

/* Print window */
function printWindow(photo){
  const w=window.open("","_blank");
  w.document.write(`
  <html>
  <head>
  <title>Resume</title>
  <style>
    body{font-family:Poppins;margin:20px}
    h1{margin:0}
    img{width:120px;height:120px;border-radius:50%}
  </style>
  </head>
  <body onload="window.print();window.close()">
    ${photo?`<img src="${photo}">`:""}
    <h1>${fullName.value}</h1>
    <p>${email.value} | ${phone.value}</p>
    <p>${address.value}</p>
    <hr>
    <h3>Objective</h3><p>${objective.value}</p>
    <h3>Skills</h3><p>${skills.value}</p>
    <h3>Projects</h3><p>${projects.value}</p>
  </body>
  </html>
  `);
}
</script>
